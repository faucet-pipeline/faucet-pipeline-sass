#!/usr/bin/env bash
set -euo pipefail

root=`dirname "$0"`
root=`realpath "$root"`

. "$root/../node_modules/faucet-pipeline/test/cli_harness.sh"

begin "$root/test_basic"
	faucet
	assert_identical "./dist/bundle.css" "./expected.css"
	assert_missing "./expected.json"
end

begin "$root/test_errors"
	faucet || echo "Crashed successfully"
	assert_identical "./dist/bundle.css" "./expected.css"
end

begin "$root/test_fingerprinting"
	faucet --fingerprint
	assert_identical "./dist/bundle-0240c59df06ce5a13dfa95cad19eab81.css" "./expected.css"
	assert_json "./dist/manifest.json" "./expected.json"
end

begin "$root/test_multi"
	faucet
	assert_identical "./dist/foo.css" "./expected_foo.css"
	assert_identical "./dist/bar.css" "./expected_bar.css"
	assert_json "./dist/manifest.json" "./expected.json"
end

begin "$root/test_compact"
	faucet --compact
	assert_identical "./dist/bundle.css" "./expected.css"
	assert_json "./dist/manifest.json" "./expected.json"
end

begin "$root/test_prefix"
	faucet
	assert_identical "./dist/bundle.css" "./expected.css"
	assert_json "./dist/manifest.json" "./expected.json"
end

begin "$root/test_no_prefix"
	faucet
	assert_identical "./dist/bundle.css" "./expected.css"
	assert_json "./dist/manifest.json" "./expected.json"
end

begin "$root/test_prefix_with_different_browserslist"
	faucet
	assert_identical "./dist/bundle.css" "./expected.css"
	assert_json "./dist/manifest.json" "./expected.json"
end

begin "$root/test_base_uri"
	faucet
	assert_identical "./dist/bundle.css" "./expected.css"
	assert_json "./dist/manifest.json" "./expected.json"
end

begin "$root/test_static_integration"
	faucet --fingerprint
	assert_identical "./dist/bundle-b28171743fab7b46cd98c3de0b5c39a6.css" "./expected.css"
	assert_json "./dist/manifest.json" "./expected.json"
end

begin "$root/test_key_config"
	faucet --fingerprint
	assert_json "./dist/manifest.json" "./expected.json"
end

echo; echo "SUCCESS: all tests passed"
